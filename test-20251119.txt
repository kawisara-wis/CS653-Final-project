(venv) lek_kwsr@Kawisaras-MacBook-Air wms-agents % python app.py
{
  "accept": true,
  "chosen_warehouse": "W1",
  "reason": {
    "type": "history_aware_selection",
    "chosen_warehouse": "W1",
    "exploration": false,
    "why": [
      "คะแนนรวมหลังปรับ: base_score × util_penalty(1.0) × diversity_penalty(1.0) = 0.860",
      "price_score(ภายในแบทช์)=0.9792 profit=963.52 margin=0.2116",
      "ระยะทาง 11.089 km → distance_score=0.0827",
      "spec_score=1.0 และประวัติ/สตรีคส่งผลต่อ fairness"
    ],
    "candidates_explained": [
      {
        "warehouse_id": "W1",
        "distance_km": 11.089,
        "utilization": 0.212,
        "availability_cbm": 8000.0,
        "price": 4554.41,
        "cost": 3590.89,
        "profit": 963.52,
        "margin": 0.2116,
        "score_components": {
          "profit": 1.0,
          "price": 0.9792,
          "distance": 0.0827,
          "sla": 1.0,
          "util_bal": 0.512,
          "util_penalty": 1.0,
          "spec": 1.0,
          "diversity_penalty": 1.0
        },
        "history": {
          "accept_rate": 0.22727272727272727,
          "ewma_util": 0.21199999999999997,
          "avg_profit": 1227.6793181818184,
          "avg_margin": 0.2319159090909091,
          "avg_price": 4852.0943181818175,
          "wins": 10,
          "bids": 44
        },
        "streak_used": 0
      },
      {
        "warehouse_id": "W2",
        "distance_km": 11.925,
        "utilization": 0.15466666666666667,
        "availability_cbm": 12800.0,
        "price": 4612.03,
        "cost": 3599.25,
        "profit": 1012.78,
        "margin": 0.2196,
        "score_components": {
          "profit": 1.0,
          "price": 0.9297,
          "distance": 0.0774,
          "sla": 1.0,
          "util_bal": 0.4547,
          "util_penalty": 1.0,
          "spec": 1.0,
          "diversity_penalty": 1.0
        },
        "history": {
          "accept_rate": 0.18181818181818182,
          "ewma_util": 0.15034916559999997,
          "avg_profit": 1246.360909090909,
          "avg_margin": 0.2346909090909092,
          "avg_price": 4872.452727272727,
          "wins": 8,
          "bids": 44
        },
        "streak_used": 0
      },
      {
        "warehouse_id": "W4",
        "distance_km": 19.792,
        "utilization": 0.148,
        "availability_cbm": 12900.0,
        "price": 5313.71,
        "cost": 3677.92,
        "profit": 1635.79,
        "margin": 0.3078,
        "score_components": {
          "profit": 1.0,
          "price": 0.3272,
          "distance": 0.0481,
          "sla": 1.0,
          "util_bal": 0.448,
          "util_penalty": 1.0,
          "spec": 1.0,
          "diversity_penalty": 1.0
        },
        "history": {
          "accept_rate": 0.18181818181818182,
          "ewma_util": 0.15266666666666667,
          "avg_profit": 1382.823409090909,
          "avg_margin": 0.25263181818181824,
          "avg_price": 5026.725681818182,
          "wins": 8,
          "bids": 44
        },
        "streak_used": 0
      },
      {
        "warehouse_id": "W5",
        "distance_km": 23.75,
        "utilization": 0.192,
        "availability_cbm": 8200.0,
        "price": 5694.73,
        "cost": 3717.5,
        "profit": 1977.23,
        "margin": 0.3472,
        "score_components": {
          "profit": 1.0,
          "price": 0.0,
          "distance": 0.0404,
          "sla": 1.0,
          "util_bal": 0.492,
          "util_penalty": 1.0,
          "spec": 1.0,
          "diversity_penalty": 1.0
        },
        "history": {
          "accept_rate": 0.18181818181818182,
          "ewma_util": 0.21299999999999997,
          "avg_profit": 1473.986590909091,
          "avg_margin": 0.2621840909090908,
          "avg_price": 5128.6672727272735,
          "wins": 8,
          "bids": 44
        },
        "streak_used": 0
      },
      {
        "warehouse_id": "W3",
        "distance_km": 11.028,
        "utilization": 0.162,
        "availability_cbm": 8500.0,
        "price": 4530.21,
        "cost": 3590.28,
        "profit": 939.93,
        "margin": 0.2075,
        "score_components": {
          "profit": 1.0,
          "price": 1.0,
          "distance": 0.0831,
          "sla": 1.0,
          "util_bal": 0.462,
          "util_penalty": 1.0,
          "spec": 1.0,
          "diversity_penalty": 0.9
        },
        "history": {
          "accept_rate": 0.22727272727272727,
          "ewma_util": 0.17914999999999998,
          "avg_profit": 1227.1020454545453,
          "avg_margin": 0.2314568181818183,
          "avg_price": 4850.851590909092,
          "wins": 10,
          "bids": 44
        },
        "streak_used": 1
      }
    ],
    "llm_summary": ""
  },
  "priced_amount": 4554.41,
  "candidates": [
    {
      "warehouse_id": "W1",
      "route": {
        "km": 11.089,
        "minutes": 21.65
      },
      "available_cbm": 8000.0,
      "utilization": 0.212,
      "sla_fit": 1.0,
      "price_amount": 4554.41,
      "cost": 3590.89,
      "profit": 963.52,
      "margin": 0.2116,
      "_raw_price": 4554.407929132055,
      "_raw_km": 11.089,
      "_wh": {
        "warehouse_id": "W1",
        "capacity_cbm": 10000.0,
        "lat": 13.649,
        "lng": 100.647,
        "name": "Bangkok DC1",
        "service_limit": 200.0,
        "status": "ACTIVE",
        "used_cbm": 2000.0
      },
      "spec_score": 1.0,
      "profit_score": 1.0,
      "price_score": 0.9792,
      "distance_score": 0.0827,
      "sla_score": 1.0,
      "util_score": 0.512,
      "util_penalty": 1.0,
      "diversity_penalty": 1.0,
      "win_streak": 0,
      "score": 0.859633
    },
    {
      "warehouse_id": "W2",
      "route": {
        "km": 11.925,
        "minutes": 20.966666666666665
      },
      "available_cbm": 12800.0,
      "utilization": 0.15466666666666667,
      "sla_fit": 1.0,
      "price_amount": 4612.03,
      "cost": 3599.25,
      "profit": 1012.78,
      "margin": 0.2196,
      "_raw_price": 4612.030464227816,
      "_raw_km": 11.925,
      "_wh": {
        "warehouse_id": "W2",
        "capacity_cbm": 15000.0,
        "lat": 13.651,
        "lng": 100.637,
        "name": "Bangkok DC2",
        "service_limit": 180.0,
        "status": "ACTIVE",
        "used_cbm": 2200.0
      },
      "spec_score": 1.0,
      "profit_score": 1.0,
      "price_score": 0.9297,
      "distance_score": 0.0774,
      "sla_score": 1.0,
      "util_score": 0.4547,
      "util_penalty": 1.0,
      "diversity_penalty": 1.0,
      "win_streak": 0,
      "score": 0.845157
    },
    {
      "warehouse_id": "W4",
      "route": {
        "km": 19.792,
        "minutes": 27.35
      },
      "available_cbm": 12900.0,
      "utilization": 0.148,
      "sla_fit": 1.0,
      "price_amount": 5313.71,
      "cost": 3677.92,
      "profit": 1635.79,
      "margin": 0.3078,
      "_raw_price": 5313.708616995548,
      "_raw_km": 19.792,
      "_wh": {
        "warehouse_id": "W4",
        "capacity_cbm": 15000.0,
        "lat": 13.627,
        "lng": 100.734,
        "name": "Bangkok DC4",
        "service_limit": 200.0,
        "status": "ACTIVE",
        "used_cbm": 2100.0
      },
      "spec_score": 1.0,
      "profit_score": 1.0,
      "price_score": 0.3272,
      "distance_score": 0.0481,
      "sla_score": 1.0,
      "util_score": 0.448,
      "util_penalty": 1.0,
      "diversity_penalty": 1.0,
      "win_streak": 0,
      "score": 0.810769
    },
    {
      "warehouse_id": "W5",
      "route": {
        "km": 23.75,
        "minutes": 32.86666666666667
      },
      "available_cbm": 8200.0,
      "utilization": 0.192,
      "sla_fit": 1.0,
      "price_amount": 5694.73,
      "cost": 3717.5,
      "profit": 1977.23,
      "margin": 0.3472,
      "_raw_price": 5694.733645669037,
      "_raw_km": 23.75,
      "_wh": {
        "warehouse_id": "W5",
        "capacity_cbm": 10000.0,
        "lat": 13.618,
        "lng": 100.736,
        "name": "Bangkok DC5",
        "service_limit": 180.0,
        "status": "ACTIVE",
        "used_cbm": 1800.0
      },
      "spec_score": 1.0,
      "profit_score": 1.0,
      "price_score": 0.0,
      "distance_score": 0.0404,
      "sla_score": 1.0,
      "util_score": 0.492,
      "util_penalty": 1.0,
      "diversity_penalty": 1.0,
      "win_streak": 0,
      "score": 0.80244
    },
    {
      "warehouse_id": "W3",
      "route": {
        "km": 11.028,
        "minutes": 20.45
      },
      "available_cbm": 8500.0,
      "utilization": 0.162,
      "sla_fit": 1.0,
      "price_amount": 4530.21,
      "cost": 3590.28,
      "profit": 939.93,
      "margin": 0.2075,
      "_raw_price": 4530.207284712904,
      "_raw_km": 11.028,
      "_wh": {
        "warehouse_id": "W3",
        "capacity_cbm": 10000.0,
        "lat": 13.655,
        "lng": 100.634,
        "name": "Bangkok DC3",
        "service_limit": 200.0,
        "status": "ACTIVE",
        "used_cbm": 1500.0
      },
      "spec_score": 1.0,
      "profit_score": 1.0,
      "price_score": 1.0,
      "distance_score": 0.0831,
      "sla_score": 1.0,
      "util_score": 0.462,
      "util_penalty": 1.0,
      "diversity_penalty": 0.9,
      "win_streak": 1,
      "score": 0.765643
    }
  ]
}

=== RESULT ===
ACCEPT: True
WAREHOUSE: W1
PRICE: 4554.41
PROFIT: 963.52 COST: 3590.89
TOP CANDIDATE: W1 11.089 km score= 0.86